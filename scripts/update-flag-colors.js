/**
 * Update countries.jsonl with extracted flag colors
 * 
 * Reads the _colors.json file generated by extract-flag-colors.js
 * and updates the flag.colors array in countries.jsonl
 * 
 * Run with: node scripts/update-flag-colors.js
 */

import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const ROOT = path.join(__dirname, '..');

const CONFIG = {
  colorsJson: path.join(ROOT, 'data/flags/_colors.json'),
  countriesJsonl: path.join(ROOT, 'data/countries.jsonl'),
};

async function main() {
  console.log('üìù Updating flag colors in countries.jsonl\n');
  
  // Read extracted colors
  const colorsData = JSON.parse(await fs.readFile(CONFIG.colorsJson, 'utf-8'));
  console.log(`   Loaded colors for ${Object.keys(colorsData).length} countries`);
  
  // Read countries.jsonl
  const jsonlContent = await fs.readFile(CONFIG.countriesJsonl, 'utf-8');
  const lines = jsonlContent.trim().split('\n');
  console.log(`   Processing ${lines.length} countries\n`);
  
  let updated = 0;
  let skipped = 0;
  
  const updatedLines = lines.map(line => {
    const country = JSON.parse(line);
    const iso = country.id;
    
    // Check if we have color data for this country
    if (colorsData[iso]) {
      const newColors = colorsData[iso].colors;
      const oldColors = country.flag?.colors || [];
      
      // Update the colors
      if (!country.flag) {
        country.flag = { colors: [], has_star: false, has_coat_of_arms: false, has_animal: false };
      }
      country.flag.colors = newColors;
      
      // Log if colors changed
      const oldStr = JSON.stringify(oldColors);
      const newStr = JSON.stringify(newColors);
      if (oldStr !== newStr) {
        console.log(`   ${iso}: ${newColors.join(', ')}`);
        updated++;
      } else {
        skipped++;
      }
    } else {
      console.log(`   ‚ö†Ô∏è  No color data for ${iso} (${country.name})`);
      skipped++;
    }
    
    return JSON.stringify(country);
  });
  
  // Write updated file
  await fs.writeFile(CONFIG.countriesJsonl, updatedLines.join('\n') + '\n');
  
  console.log(`\n‚úÖ Updated ${updated} countries, ${skipped} unchanged/skipped`);
  console.log(`üìÑ Saved to: ${CONFIG.countriesJsonl}`);
}

main().catch(console.error);

