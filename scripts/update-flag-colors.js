/**
 * Update countries.jsonl with extracted flag colors
 * 
 * Reads the _colors.json file generated by extract-flag-colors.js
 * and updates ONLY the flag.colors array in countries.jsonl.
 * All other fields are preserved.
 * 
 * Run with: node scripts/update-flag-colors.js
 */

import fs from 'fs/promises';
import path from 'path';
import { updateCountries, paths } from './lib/countries-jsonl.js';

const COLORS_JSON = path.join(paths.flags, '_colors.json');

async function main() {
  console.log('Loading extracted flag colors...');
  
  let colorsData;
  try {
    colorsData = JSON.parse(await fs.readFile(COLORS_JSON, 'utf-8'));
    console.log(`  Loaded colors for ${Object.keys(colorsData).length} countries`);
  } catch (err) {
    if (err.code === 'ENOENT') {
      console.log('  No _colors.json found. Run extract-flag-colors.js first.');
      process.exit(1);
    }
    throw err;
  }
  
  console.log('\nUpdating countries.jsonl...');
  
  let colorsUpdated = 0;
  let noData = 0;
  
  const { updated, total } = await updateCountries((country, iso) => {
    if (colorsData[iso]) {
      const newColors = colorsData[iso].colors;
      colorsUpdated++;
      
      // Return ONLY the fields we manage
      return {
        flag: {
          colors: newColors
        }
      };
    } else {
      noData++;
      console.log(`  ⚠️  No color data for ${iso} (${country.name})`);
      return null;
    }
  });
  
  console.log(`\n  Updated ${colorsUpdated} countries with color data`);
  console.log(`  ${noData} countries without color data`);
  
  console.log('\nDone!');
}

main().catch(console.error);
